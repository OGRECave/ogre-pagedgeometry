<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PagedGeometry: Tutorial 2: Trees and Bushes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PagedGeometry
   &#160;<span id="projectnumber">1.3.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('tut2.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Tutorial 2: Trees and Bushes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__home_pavel_workspace_ogre_pagedgeometry_docs_Tutorial_2"></a></p>
<h1><a class="anchor" id="autotoc_md7"></a>
Introduction</h1>
<p>As you've seen in Lesson 1, once you know how to set up PagedGeometry, adding trees to your world is as easy as calling TreeLoader3D::addTree(). This tutorial expands on what you already know, and explains the fastest way to add trees and bushes to your scene.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Tutorial Requirements</h2>
<ul>
<li><a class="el" href="tut1.html">Tutorial 1: Getting Started</a></li>
<li>A basic understanding of <a class="elRef" href="https://ogrecave.github.io/ogre/api/latest/namespace_ogre.html">Ogre</a></li>
<li>Some experience using C++</li>
</ul>
<p>See also</p>
<ul>
<li>Example 3 - “Trees and Bushes”</li>
<li>Example 2 - “TreeLoader2D”</li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
Level of Detail</h1>
<p>If you want, you can add trees, bushes, rocks, any pretty much anything you like to your scene using the PagedGeometry object from Lesson 1. But at a certain point you may find that even with all of PagedGeometry's batching and impostoring optimizations, the frame rate might not be as high as you like.</p>
<p>Bushes, rocks, and other small ground details aren't nearly as important as trees in the distance. If you reduce the viewing range of this “ground clutter”, you'll get a considerable performance boost without much noticeable loss of visual quality. For example, if your trees are visible up to a half of a mile, your bushes / rocks / etc. may only need to be rendered up to one or two hundred yards. This way, you can include a high level of detail (bushes, rocks, etc.) in your scene without wasting too much time rendering them in the far distance.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Multiple View Ranges</h1>
<p>At this point you may be wondering how you're going to assign multiple view ranges to different types of entities, etc. Fortunately, there is a very easy way to achieve this: Create two instances of PagedGeometry - one is set up to render trees how you want, and the other is set up to render bushes how you want (with the closer view range).</p>
<p>This is the tree setup code:</p>
<div class="fragment"><div class="line">PagedGeometry *trees = <span class="keyword">new</span> PagedGeometry(camera, 50);</div>
<div class="line"> </div>
<div class="line">trees-&gt;addDetailLevel&lt;BatchPage&gt;(150, 30);</div>
<div class="line"> </div>
<div class="line">trees-&gt;addDetailLevel&lt;ImpostorPage&gt;(400, 50);</div>
</div><!-- fragment --><p>This is basically the same as the code seen in Lesson 1, with a few changes: The camera and pageSize data is specified in the constructor, rather than being set through functions. Also, trees-&gt;setInfinite() was removed since infinite mode is already enabled by default.</p>
<p>As you can see, the code sets up batches up to 150 units and impostors up to 400 units. While this should work fine for trees, the bushes won't need to be rendered this far, so another PagedGeometry object will be created for the sole purpose of rendering bushes/rocks/etc.:</p>
<div class="fragment"><div class="line">PagedGeometry *bushes = <span class="keyword">new</span> PagedGeometry(camera, 40);</div>
<div class="line"> </div>
<div class="line">bushes-&gt;addDetailLevel&lt;BatchPage&gt;(80, 20);</div>
<div class="line"> </div>
<div class="line">bushes-&gt;addDetailLevel&lt;ImpostorPage&gt;(160, 40);</div>
</div><!-- fragment --><p>Note that since this new PagedGeometry object (“bushes”) is independent from “trees”, you can set up the LODs completely differently if you like. In this case, BatchPage and ImpostorPage are still used, but the ranges are changed to roughly half of what the trees will be using.</p>
<p>Now it's time to assign PageLoader's to the PagedGeometry objects. Obviously, each PagedGeometry object will need it's own PageLoader object so you can add your trees and bushes:</p>
<div class="fragment"><div class="line">TreeLoader3D *treeLoader = <span class="keyword">new</span> TreeLoader3D(trees, TBounds(0, 0, 1500,</div>
<div class="line">1500));</div>
<div class="line"> </div>
<div class="line">trees-&gt;setPageLoader(treeLoader);</div>
<div class="line"> </div>
<div class="line">TreeLoader3D *bushLoader = <span class="keyword">new</span> TreeLoader3D(bushes, TBounds(0, 0, 1500,</div>
<div class="line">1500));</div>
<div class="line"> </div>
<div class="line">bushes-&gt;setPageLoader(bushLoader);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
Adding the Trees and Bushes</h1>
<p>At this point you should add all your trees to treeLoader, all your bushes to bushLoader, and your scene should be ready to go. The following code randomely places trees and bushes, but is of course for demonstration purposes (normally you'd use a level editor of some sort to place them):</p>
<div class="fragment"><div class="line">Entity *myTree = sceneMgr-&gt;createEntity(<span class="stringliteral">&quot;MyTree&quot;</span>, <span class="stringliteral">&quot;tree.mesh&quot;</span>);</div>
<div class="line"> </div>
<div class="line">Entity *myBush = sceneMgr-&gt;createEntity(<span class="stringliteral">&quot;MyBush&quot;</span>, <span class="stringliteral">&quot;bush.mesh&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Add trees</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">float</span> x = 0, y = 0, z = 0, yaw, scale;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10000; i++){</div>
<div class="line"> </div>
<div class="line">yaw = Math::RangeRandom(0, 360);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (Math::RangeRandom(0, 1) &lt;= 0.8f){</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Clump trees together occasionally</span></div>
<div class="line"> </div>
<div class="line">x += Math::RangeRandom(-10.0f, 10.0f);</div>
<div class="line"> </div>
<div class="line">z += Math::RangeRandom(-10.0f, 10.0f);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (x &lt; 0) x = 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt; 1500) x = 1500;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (z &lt; 0) z = 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (z &gt; 1500) z = 1500;</div>
<div class="line"> </div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line"> </div>
<div class="line">x = Math::RangeRandom(0, 1500);</div>
<div class="line"> </div>
<div class="line">z = Math::RangeRandom(0, 1500);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">y = getTerrainHeight(x, z);</div>
<div class="line"> </div>
<div class="line">scale = Math::RangeRandom(0.9f, 1.1f);</div>
<div class="line"> </div>
<div class="line">treeLoader-&gt;addTree(myTree, <a class="codeRef" href="https://ogrecave.github.io/ogre/api/latest/class_ogre_1_1_vector.html">Vector3</a>(x, y, z), Degree(yaw), scale);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Add bushes</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">float</span> x = 0, y = 0, z = 0, yaw, scale;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 20000; i++){</div>
<div class="line"> </div>
<div class="line">yaw = Math::RangeRandom(0, 360);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (Math::RangeRandom(0, 1) &lt;= 0.3f){</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Clump bushes together occasionally</span></div>
<div class="line"> </div>
<div class="line">x += Math::RangeRandom(-10.0f, 10.0f);</div>
<div class="line"> </div>
<div class="line">z += Math::RangeRandom(-10.0f, 10.0f);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (x &lt; 0) x = 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt; 1500) x = 1500;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (z &lt; 0) z = 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (z &gt; 1500) z = 1500;</div>
<div class="line"> </div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line"> </div>
<div class="line">x = Math::RangeRandom(0, 1500);</div>
<div class="line"> </div>
<div class="line">z = Math::RangeRandom(0, 1500);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">y = getTerrainHeight(x, z);</div>
<div class="line"> </div>
<div class="line">scale = Math::RangeRandom(0.9f, 1.1f);</div>
<div class="line"> </div>
<div class="line">bushLoader-&gt;addTree(myBush, <a class="codeRef" href="https://ogrecave.github.io/ogre/api/latest/class_ogre_1_1_vector.html">Vector3</a>(x, y, z), Degree(yaw), scale);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclass_ogre_1_1_vector_html"><div class="ttname"><a href="https://ogrecave.github.io/ogre/api/latest/class_ogre_1_1_vector.html">Vector&lt; 3, Real &gt;</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
Updating PagedGeometry</h1>
<p>And to finish, remember to call both trees-&gt;update() <em>and</em> bushes-&gt;update() every frame:</p>
<div class="fragment"><div class="line">[each frame]</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">trees-&gt;update();</div>
<div class="line"> </div>
<div class="line">bushes-&gt;update();</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
Optimizing</h1>
<p>Now you should have trees and bushes rendering in a fairly optimized setup. At this point it usually helps to play around with the page sizes and batching/impostoring view ranges. Try to find values that give the best possible performance without losing rendering quality.</p>
<p>Optimizing Tips</p>
<ul>
<li>Larger page sizes render more efficiently what is on the screen, but also causes more off-screen entities to be rendered. Depending on the volume and view range of your trees/bushes, decreasing or increasing the page size may give better performance.</li>
<li>Generally, you should adjust the batching range as low as possible without making the flatness of impostors obvious. However, excessively low batching ranges can actually run slower, since when impostors are rendered near the camera there can be more overdraw.</li>
<li>Once you have near-optimal FPS, try moving the camera around in your game. If high speed camera movement results in stuttering frame rates, then your page size may be too large. In this case, reduce the page size until the stuttering is no longer a problem. It may also help to enable bounded mode (PagedGeometry::setBounds())</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
TreeLoader2D (Optional)</h1>
<p>You may notice in the example above in the "procedural" tree / bush placement code that GetTerrainHeight() is called to get the height of the terrain at any given x/z coordinate. Obviously, the height needs to be calculated this way so trees are placed on the terrain, not under it.</p>
<p>If all your trees use "Y = getTerrainHeight(X, Z)" to calculate the height, you can save a good amount of memory by switching to TreeLoader2D (rather than TreeLoader3D). This version of TreeLoader3D ignores the vertical (Y) component of the position when you call addTree(), and instead calculates the Y value later from the X/Z values, using the function you provide. For example:</p>
<div class="fragment"><div class="line">TreeLoader2D *treeLoader = <span class="keyword">new</span> TreeLoader2D(trees, TBounds(0, 0, 1500,</div>
<div class="line">1500));</div>
<div class="line"> </div>
<div class="line">trees-&gt;setPageLoader(treeLoader);</div>
<div class="line"> </div>
<div class="line">treeLoader-&gt;setHeightFunction(&amp;getTerrainHeight);</div>
<div class="line"> </div>
<div class="line">treeLoader-&gt;addTree(myEntity, <a class="codeRef" href="https://ogrecave.github.io/ogre/api/latest/class_ogre_1_1_vector.html">Vector2</a>(x, 0, z), yaw, scale);</div>
</div><!-- fragment --><p>TreeLoader2D is basically identical to TreeLoader3D, except setHeightFunction() is used to supply TreeLoader2D with your function that will be used to calculate the Y coordinates of each tree (from the X and Z coordinates), and addTree() ignores the Y component of the position you supply.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Conclusion</h1>
<p>Adding trees, bushes, rockes, and many other details to your game world is very easy, but acheiving good frame rates often takes a little tweaking. Fortunately, PagedGeometry makes it easy to configure LODs and view ranges in almost any way, allowing you to effeciently render vast forests and jungles with dense brush and vegetation.</p>
<p>In the examples folder, you can get a full working example of what you learned in this tutorial by opening the "Example 3 – Trees and Bushes" project. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
